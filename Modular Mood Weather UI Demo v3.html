<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Enhanced Favorites - Feeling Forecast</title>
  <style>
    :root {
      --overlay-color: #87c9e7;
      --bg-filter: blur(4px) brightness(0.85);
      --glass-bg: rgba(33,37,59,0.5);
      --glass-color: #e0f7fa;
    }
    body {
      margin: 0; min-height: 100vh;
      font-family: 'Segoe UI', sans-serif;
      background: #21253b;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      position: relative; overflow: hidden;
    }
    #bg-img {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      object-fit: cover; z-index: 0;
      filter: var(--bg-filter);
      pointer-events: none;
      transition: filter 0.4s;
      display: none;
    }
    #rain-svg, #snow-svg, #clear-svg {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      pointer-events: none; z-index: 1; display: none;
    }
    .glass {
      position: relative; z-index: 2;
      background: var(--glass-bg); border-radius: 18px; padding: 2rem 3rem;
      color: var(--glass-color); margin-top: 2rem;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.16);
      text-align: center;
      backdrop-filter: blur(12px);
    }
    .controls {
      display: flex; gap: 1.5rem; z-index: 3; position: relative;
      background: rgba(33,37,59,0.42); padding: 1rem 2rem; border-radius: 12px;
      margin-top: 2rem;
    }
    select, .upload-btn, .fav-btn, .auto-btn {
      padding: 0.5rem 1rem; border-radius: 8px; border: none; font-size: 1rem;
      background: #23253b; color: #fff;
      box-shadow: 0 2px 8px rgba(33,37,59,0.18);
    }
    label { color: #e0f7fa; font-size: 1rem; }
    .fav-btn, .auto-btn {
      background: #ffe066; color: #21253b; font-weight: bold; cursor: pointer;
      transition: background 0.2s;
      margin-left: 1rem;
    }
    .fav-btn:hover, .auto-btn:hover { background: #ffe77a; }
    .favorites {
      display: flex; gap: 1.2rem; flex-wrap: wrap;
      margin-top: 2.5rem; z-index: 3; position: relative;
      background: rgba(33,37,59,0.3); padding: 1rem 2rem; border-radius: 16px;
    }
    .favorite {
      border-radius: 12px; overflow: hidden; cursor: pointer; box-shadow: 0 4px 20px 0 rgba(20,20,40,0.12);
      background: #12151e;
      display: flex; flex-direction: column; align-items: center;
      min-width: 96px; max-width: 140px;
      transition: transform 0.1s;
      position: relative;
    }
    .favorite:hover { transform: scale(1.05);}
    .favorite img {
      width: 96px; height: 64px; object-fit: cover; border-bottom: 2px solid #ffe066;
      filter: blur(1.5px) brightness(0.7);
    }
    .fav-label {
      font-size: 0.93rem; color: #ffe066; margin: 0.4rem 0 0.3rem 0;
      text-align: center;
      width: 100%;
      word-break: break-all;
    }
    .meta-info {
      font-size: 0.8rem; color: #90a4ae; margin-bottom: 0.3rem; text-align: center;
      width: 100%;
    }
    .delete-btn {
      background: transparent; border: none; color: #ff7272; font-size: 1.25rem; cursor: pointer;
      position: absolute; top: 0.1rem; right: 0.1rem; z-index: 2;
      transition: color 0.2s;
    }
    .delete-btn:hover { color: #e04848; }
  </style>
</head>
<body>
  <img id="bg-img">
  <svg id="rain-svg"></svg>
  <svg id="snow-svg"></svg>
  <svg id="clear-svg"></svg>
  <div class="controls">
    <label>
      Mood:
      <select id="mood">
        <option>Calm</option>
        <option>Energetic</option>
        <option>Sad</option>
        <option>Happy</option>
        <option>Romantic</option>
      </select>
    </label>
    <label>
      Weather:
      <select id="weather">
        <option>Rain</option>
        <option>Snow</option>
        <option>Clear</option>
        <option>Cloudy</option>
      </select>
    </label>
    <label>
      Time:
      <select id="time">
        <option>Night</option>
        <option>Morning</option>
        <option>Afternoon</option>
        <option>Evening</option>
      </select>
    </label>
    <label>
      <input type="file" id="img-upload" accept="image/*" class="upload-btn">
      Upload Image
    </label>
    <input id="fav-label-input" type="text" placeholder="Favorite Label..." maxlength="24" style="padding: 0.5rem 0.7rem; border-radius:8px; margin-left:1rem; border:none; background:#181b2b; color:#ffe066; font-size:1rem;">
    <button class="fav-btn" id="save-fav">Save Favorite</button>
    <button class="auto-btn" id="auto-btn">Auto Mode</button>
  </div>
  <div class="glass" id="glass-info">
    <h1>Dynamic Mood Visualizer</h1>
    <p id="desc">Mood: Calm | Weather: Rain | Time: Night</p>
  </div>
  <div class="favorites" id="favorites-list"></div>
  <script>
    // Elements
    const bgImg = document.getElementById('bg-img');
    const imgUpload = document.getElementById('img-upload');
    const mood = document.getElementById('mood');
    const weather = document.getElementById('weather');
    const time = document.getElementById('time');
    const desc = document.getElementById('desc');
    const rainSvg = document.getElementById('rain-svg');
    const snowSvg = document.getElementById('snow-svg');
    const clearSvg = document.getElementById('clear-svg');
    const saveFav = document.getElementById('save-fav');
    const favoritesList = document.getElementById('favorites-list');
    const favLabelInput = document.getElementById('fav-label-input');
    const autoBtn = document.getElementById('auto-btn');

    let currentImgData = "";
    let lastAutoLocation = null;

    // ---- Overlay functions ----
    function createRain(count) {
      rainSvg.innerHTML = ''; rainSvg.style.display = 'block';
      snowSvg.style.display = clearSvg.style.display = 'none';
      rainSvg.setAttribute('width', window.innerWidth);
      rainSvg.setAttribute('height', window.innerHeight);
      for(let i = 0; i < count; i++) {
        let x = Math.random() * window.innerWidth;
        let delay = Math.random() * 2;
        let duration = 0.7 + Math.random();
        let drop = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        drop.setAttribute('x', x);
        drop.setAttribute('y', -20);
        drop.setAttribute('width', 2);
        drop.setAttribute('height', 20 + Math.random() * 10);
        drop.setAttribute('fill', getComputedStyle(document.documentElement).getPropertyValue('--overlay-color'));
        drop.style.opacity = 0.5 + Math.random() * 0.3;
        drop.animate([
          { transform: `translateY(0)` },
          { transform: `translateY(${window.innerHeight + 40}px)` }
        ], {
          duration: duration * 1000,
          delay: delay * 1000,
          iterations: Infinity
        });
        rainSvg.appendChild(drop);
      }
    }
    function createSnow(count) {
      snowSvg.innerHTML = ''; snowSvg.style.display = 'block';
      rainSvg.style.display = clearSvg.style.display = 'none';
      snowSvg.setAttribute('width', window.innerWidth);
      snowSvg.setAttribute('height', window.innerHeight);
      for(let i = 0; i < count; i++) {
        let x = Math.random() * window.innerWidth;
        let size = 2 + Math.random() * 3;
        let duration = 2 + Math.random() * 2;
        let delay = Math.random() * 2;
        let flake = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        flake.setAttribute('cx', x);
        flake.setAttribute('cy', -10);
        flake.setAttribute('r', size);
        flake.setAttribute('fill', "#fff");
        flake.style.opacity = 0.5 + Math.random() * 0.5;
        flake.animate([
          { transform: `translateY(0)` },
          { transform: `translateY(${window.innerHeight + 30}px)` }
        ], {
          duration: duration * 1000,
          delay: delay * 1000,
          iterations: Infinity
        });
        snowSvg.appendChild(flake);
      }
    }
    function createClear() {
      clearSvg.innerHTML = ''; clearSvg.style.display = 'block';
      rainSvg.style.display = snowSvg.style.display = 'none';
      clearSvg.setAttribute('width', window.innerWidth);
      clearSvg.setAttribute('height', window.innerHeight);
      let sun = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      sun.setAttribute('cx', window.innerWidth * 0.8);
      sun.setAttribute('cy', window.innerHeight * 0.2);
      sun.setAttribute('r', 80);
      sun.setAttribute('fill', '#ffe066');
      sun.style.opacity = 0.8;
      clearSvg.appendChild(sun);
    }
    // ---- End overlay functions ----

    // ---- Background Image Upload ----
    imgUpload.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(ev) {
        currentImgData = ev.target.result;
        bgImg.src = ev.target.result;
        bgImg.style.display = 'block';
      }
      reader.readAsDataURL(file);
    });

    // ---- UI update logic ----
    function updateAll(skipOverlay) {
      const m = mood.value, w = weather.value, t = time.value;
      desc.textContent = `Mood: ${m} | Weather: ${w} | Time: ${t}`;
      // Pick overlay & color based on weather
      if(!skipOverlay) {
        if(w === "Rain") { createRain(60); document.documentElement.style.setProperty('--overlay-color', '#87c9e7'); }
        else if(w === "Snow") { createSnow(60); document.documentElement.style.setProperty('--overlay-color', '#fff'); }
        else if(w === "Clear") { createClear(); document.documentElement.style.setProperty('--overlay-color', '#ffe066'); }
        else { rainSvg.style.display = snowSvg.style.display = clearSvg.style.display = 'none'; }
      }
      // Pick glass color for mood
      if(m === "Sad") { document.documentElement.style.setProperty('--glass-bg', 'rgba(33,37,59,0.7)'); document.documentElement.style.setProperty('--glass-color', '#90a4ae'); }
      else if(m === "Energetic") { document.documentElement.style.setProperty('--glass-bg', 'rgba(255,234,128,0.5)'); document.documentElement.style.setProperty('--glass-color', '#444'); }
      else if(m === "Happy") { document.documentElement.style.setProperty('--glass-bg', 'rgba(135,201,231,0.6)'); document.documentElement.style.setProperty('--glass-color', '#222'); }
      else if(m === "Romantic") { document.documentElement.style.setProperty('--glass-bg', 'rgba(230,93,129,0.4)'); document.documentElement.style.setProperty('--glass-color', '#fff'); }
      else { document.documentElement.style.setProperty('--glass-bg', 'rgba(33,37,59,0.5)'); document.documentElement.style.setProperty('--glass-color', '#e0f7fa'); }
      // Adjust glass filter for time
      if(t === "Night") document.documentElement.style.setProperty('--bg-filter', 'blur(4px) brightness(0.6)');
      else if(t === "Morning") document.documentElement.style.setProperty('--bg-filter', 'blur(4px) brightness(1.0)');
      else if(t === "Afternoon") document.documentElement.style.setProperty('--bg-filter', 'blur(4px) brightness(0.9)');
      else document.documentElement.style.setProperty('--bg-filter', 'blur(4px) brightness(0.8)');
    }
    mood.addEventListener('change', updateAll);
    weather.addEventListener('change', updateAll);
    time.addEventListener('change', updateAll);
    window.addEventListener('resize', () => updateAll(true));

    // ---- Favorites ----
    function getFavorites() {
      return JSON.parse(localStorage.getItem('ff_favorites') || '[]');
    }
    function saveFavorites(favs) {
      localStorage.setItem('ff_favorites', JSON.stringify(favs));
    }
    function renderFavorites() {
      const favs = getFavorites();
      favoritesList.innerHTML = "";
      if (!favs.length) {
        favoritesList.textContent = "No favorites saved yet!";
        return;
      }
      favs.forEach((fav, idx) => {
        const div = document.createElement('div');
        div.className = "favorite";
        if (fav.image) {
          const img = document.createElement('img');
          img.src = fav.image;
          div.appendChild(img);
        }
        const label = document.createElement('div');
        label.className = "fav-label";
        label.textContent = fav.label || `${fav.mood} / ${fav.weather} / ${fav.time}`;
        div.appendChild(label);
        const meta = document.createElement('div');
        meta.className = "meta-info";
        let dt = new Date(fav.ts);
        meta.textContent = `${dt.toLocaleString()}${fav.source ? ' • '+fav.source : ''}`;
        div.appendChild(meta);

        const delBtn = document.createElement('button');
        delBtn.className = "delete-btn";
        delBtn.innerHTML = "🗑️";
        delBtn.onclick = (e) => {
          e.stopPropagation();
          const favsNew = getFavorites();
          favsNew.splice(idx, 1);
          saveFavorites(favsNew);
          renderFavorites();
        };
        div.appendChild(delBtn);

        div.title = "Click to load this favorite";
        div.onclick = (e) => {
          if (e.target.classList.contains('delete-btn')) return;
          mood.value = fav.mood;
          weather.value = fav.weather;
          time.value = fav.time;
          if (fav.image) {
            currentImgData = fav.image;
            bgImg.src = fav.image;
            bgImg.style.display = 'block';
          } else {
            currentImgData = "";
            bgImg.src = "";
            bgImg.style.display = 'none';
          }
          updateAll();
        };
        favoritesList.appendChild(div);
      });
    }
    saveFav.onclick = () => {
      const fav = {
        label: favLabelInput.value.trim() || "",
        mood: mood.value,
        weather: weather.value,
        time: time.value,
        image: currentImgData || "",
        ts: Date.now(),
        source: lastAutoLocation ? "Auto" : "Manual"
      };
      const favs = getFavorites();
      favs.push(fav);
      saveFavorites(favs);
      renderFavorites();
      favLabelInput.value = "";
    };

// --- Minimal Festival Data (can expand later) ---
const FESTIVALS = [
  // Date in "MM-DD", country in uppercase 2-letter ISO, city/cities optional
  { date: "01-26", country: "IN", name: "Republic Day" },
  { date: "03-08", country: "IN", name: "Holi" },
  { date: "11-01", country: "IN", name: "Diwali" },
  { date: "12-25", country: "US", name: "Christmas" },
  { date: "07-04", country: "US", name: "Independence Day" },
  { date: "07-14", country: "FR", name: "Bastille Day" },
  { date: "10-31", country: "US", name: "Halloween" },
  { date: "12-25", country: "GB", name: "Christmas" },
  { date: "12-25", country: "IN", name: "Christmas" },
  { date: "08-15", country: "IN", name: "Independence Day" }
  // ...add more as needed
];

    // ---- Auto Mode ----
autoBtn.onclick = () => {
  if (!navigator.geolocation) {
    alert("Geolocation not supported in this browser.");
    return;
  }
  autoBtn.textContent = "Auto Detecting...";
  navigator.geolocation.getCurrentPosition(async (pos) => {
    const lat = pos.coords.latitude, lon = pos.coords.longitude;
    let city = "Your Location";
    let country = "IN"; // Default fallback
    try {
      // Try reverse geocode for city/country
      const geoRes = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`);
      const geoData = await geoRes.json();
      city = geoData.address.city || geoData.address.town || geoData.address.village || geoData.address.county || city;
      country = geoData.address.country_code ? geoData.address.country_code.toUpperCase() : country;
    } catch(e) { }
    // --- Weather ---
    let weatherDesc = "Clear";
    let hour = new Date().getHours();
    try {
      const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`;
      const wRes = await fetch(weatherUrl);
      const wData = await wRes.json();
      if (wData.current_weather && wData.current_weather.weathercode !== undefined) {
        const code = wData.current_weather.weathercode;
        if ([61,63,65,80,81,82].includes(code)) weatherDesc = "Rain";
        else if ([71,73,75,77,85,86].includes(code)) weatherDesc = "Snow";
        else if ([1,2,3,45,48].includes(code)) weatherDesc = "Cloudy";
        else weatherDesc = "Clear";
      }
    } catch(e) {}
    // --- Time of day ---
    let timeVal = "Afternoon";
    if (hour < 6 || hour >= 20) timeVal = "Night";
    else if (hour < 12) timeVal = "Morning";
    else if (hour < 17) timeVal = "Afternoon";
    else timeVal = "Evening";
    // --- Festival detection ---
    let festivalToday = null;
    const today = new Date();
    const todayKey = ("0"+(today.getMonth()+1)).slice(-2) + "-" + ("0"+today.getDate()).slice(-2);
    for (const f of FESTIVALS) {
      if (f.date === todayKey && f.country === country) {
        festivalToday = f;
        break;
      }
    }
    // --- Auto mood logic ---
    let moodVal = "Calm";
    if (festivalToday) moodVal = "Happy";
    else if (weatherDesc === "Rain" && timeVal === "Night") moodVal = "Sad";
    else if (weatherDesc === "Clear" && timeVal === "Morning") moodVal = "Energetic";
    else if (weatherDesc === "Snow") moodVal = "Romantic";
    else moodVal = "Calm";
    // --- Apply in UI ---
    weather.value = weatherDesc;
    time.value = timeVal;
    mood.value = moodVal;
    let extraInfo = `${city}, ${country}`;
    if (festivalToday) extraInfo += ` • Today: ${festivalToday.name}`;
    desc.textContent = `Mood: ${moodVal} | Weather: ${weatherDesc} | Time: ${timeVal} | ${extraInfo}`;
    lastAutoLocation = city;
    updateAll();
    autoBtn.textContent = "Auto Mode";
  }, (err) => {
    alert("Could not get location: " + err.message);
    autoBtn.textContent = "Auto Mode";
  });
};

    // ---- Init ----
    updateAll();
    renderFavorites();
  </script>
</body>
</html>
